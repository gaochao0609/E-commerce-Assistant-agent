## ğŸ“Š E-commerce-Assistant-agent é¡¹ç›®è¿è¡Œæµç¨‹è¯¦è§£

åŸºäºæ‚¨è¾“å…¥"æˆ‘æƒ³çœ‹ä¸‹ä»Šå¤©çš„è¿è¥æ•°æ®å’Œæ—¥æŠ¥"å¹¶ç‚¹å‡»å‘é€è¯·æ±‚ï¼Œæˆ‘ä¸ºæ‚¨è¯¦ç»†æ¢³ç†æ•´ä¸ªé¡¹ç›®çš„å®Œæ•´è¿è¡Œæµç¨‹ï¼š

---

## **ç¬¬ä¸€é˜¶æ®µï¼šç³»ç»Ÿåˆå§‹åŒ–å¯åŠ¨**

### 1ï¸âƒ£ **åº”ç”¨å¯åŠ¨å…¥å£** (`run_app.py`)

```python
python run_app.py
```

ä¸»è¦æ­¥éª¤ï¼š
- âœ… **æ£€æŸ¥å‰ç«¯ç›®å½•** (`src/ai_dashboard`) æ˜¯å¦å­˜åœ¨
- âœ… **æ£€æŸ¥ç«¯å£å ç”¨** - é»˜è®¤ MCP æœåŠ¡å™¨ç«¯å£ 8000ï¼Œå‰ç«¯ç«¯å£ 3001
- âœ… **å¯åŠ¨ MCP æœåŠ¡å™¨**
  ```bash
  python -m operations_dashboard.mcp_server streamable-http --host 127.0.0.1 --port 8000
  ```
- âœ… **å¯åŠ¨ Next.js å‰ç«¯**
  ```bash
  npm run dev  # åœ¨ src/ai_dashboard ç›®å½•ä¸‹
  ```
- âœ… **è‡ªåŠ¨é…ç½®ç¯å¢ƒå˜é‡**
  - `MCP_SERVER_URL` â†’ `http://127.0.0.1:8000/mcp`
  - `AI_DASHBOARD_CONFIG_PATH` â†’ `configs/ai_dashboard.json`

---

## **ç¬¬äºŒé˜¶æ®µï¼šåç«¯æœåŠ¡åˆå§‹åŒ–**

### 2ï¸âƒ£ **MCP æœåŠ¡å™¨å¯åŠ¨** (`operations_dashboard/mcp_server. py`)

**FastMCP æ¡†æ¶åˆå§‹åŒ–ï¼š**

```
â”Œâ”€ app_lifespan (ç”Ÿå‘½å‘¨æœŸé’©å­)
â”‚
â”œâ”€ 1. åŠ è½½é…ç½® (_load_config)
â”‚  â””â”€ è¯»å– OPENAI_API_KEYã€AMAZON å‡­è¯ç­‰
â”‚
â”œâ”€ 2. åˆ›å»ºæœåŠ¡ä¸Šä¸‹æ–‡ (create_service_context)
â”‚  â””â”€ ServiceContext {
â”‚      config: AppConfig,
â”‚      data_source: é»˜è®¤ Mock æ•°æ®æº,
â”‚      repository: SQLite ä»“å‚¨,
â”‚      llm:  ChatOpenAI å®ä¾‹
â”‚    }
â”‚
â””â”€ 3. æ„å»ºæŠ€èƒ½ç´¢å¼• (build_dashboard_skills)
   â””â”€ 10 ä¸ª MCP å·¥å…·å…¨éƒ¨åˆå§‹åŒ–
```

**æš´éœ²çš„ 10 ä¸ª MCP å·¥å…·ï¼š**
- `fetch_dashboard_data` - è·å–åŸå§‹é”€å”®/æµé‡æ•°æ®
- `compute_dashboard_metrics` - è®¡ç®— KPI æ‘˜è¦
- `generate_dashboard_insights` - ç”Ÿæˆ AI æ´å¯Ÿ
- `analyze_dashboard_history` - è¶‹åŠ¿åˆ†æ
- `export_dashboard_history` - å¯¼å‡º CSV
- `amazon_bestseller_search` - ç•…é”€æ¦œæŸ¥è¯¢
- `save_upload_table` - ä¿å­˜ä¸Šä¼ è¡¨æ ¼
- `get_upload_table` - è·å–ä¸Šä¼ è®°å½•
- `list_upload_tables` - åˆ—å‡ºä¸Šä¼ å†å²
- `delete_upload_table` - åˆ é™¤ä¸Šä¼ è®°å½•

**CORS ä¸­é—´ä»¶é…ç½®**ï¼š
```javascript
Allow-Origins: "*"
Allow-Methods:  ["GET", "POST", "DELETE", "OPTIONS"]
```

---

## **ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯ç•Œé¢åŠ è½½**

### 3ï¸âƒ£ **Next.js å‰ç«¯å¯åŠ¨** (`src/ai_dashboard`)

**é¡µé¢ç»“æ„ï¼š**
```
src/ai_dashboard/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ page. jsx          # ä¸»é¡µå…¥å£
â”‚   â”œâ”€â”€ layout.jsx         # å…¨å±€å¸ƒå±€
â”‚   â”œâ”€â”€ globals.css        # å…¨å±€æ ·å¼
â”‚   â””â”€â”€ api/
â”‚       â”œâ”€â”€ chat/route.js  # âœ¨ æ ¸å¿ƒ API ç«¯ç‚¹
â”‚       â””â”€â”€ upload/route.js
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ Dashboard. jsx      # ä¸»ä»ªè¡¨ç›˜å®¹å™¨
â”‚   â”œâ”€â”€ ChatPanel.jsx      # å¯¹è¯é¢æ¿
â”‚   â”œâ”€â”€ FileUpload.jsx     # æ–‡ä»¶ä¸Šä¼ 
â”‚   â””â”€â”€ InsightsPanel.jsx  # æ•°æ®å±•ç¤º
â”‚
â””â”€â”€ lib/
    â”œâ”€â”€ mcpClient.js       # MCP HTTP å®¢æˆ·ç«¯
    â”œâ”€â”€ prompt.js          # ç³»ç»Ÿæç¤ºè¯
    â”œâ”€â”€ intent.js          # æ„å›¾è¯†åˆ«
    â””â”€â”€ ... å…¶ä»–å·¥å…·åº“
```

**åˆå§‹åŒ–æ­¥éª¤ï¼š**
1. âœ… åŠ è½½è¿è¡Œæ—¶é…ç½® (`getRuntimeConfig`)
2. âœ… åˆå§‹åŒ– `useChat` Hookï¼ˆæ¥è‡ª `ai` åº“ï¼‰
3. âœ… åœ¨å‰ç«¯æ¸²æŸ“åˆå§‹æ¬¢è¿æ¶ˆæ¯
4. âœ… åŠ è½½ä¸Šä¼ å†å² (`GET /api/uploads`)

---

## **ç¬¬å››é˜¶æ®µï¼šç”¨æˆ·è¾“å…¥å¤„ç†**

### 4ï¸âƒ£ **å‰ç«¯æ¶ˆæ¯æäº¤** (`components/Dashboard.jsx` + `components/ChatPanel.jsx`)

**ç”¨æˆ·æ“ä½œï¼š**
```
ç”¨æˆ·è¾“å…¥:  "æˆ‘æƒ³çœ‹ä¸‹ä»Šå¤©çš„è¿è¥æ•°æ®å’Œæ—¥æŠ¥"
         â†“
ç‚¹å‡» "å‘é€è¯·æ±‚" æŒ‰é’®
         â†“
handleChatSubmit(event)
```

**å‰ç«¯å¤„ç†æµç¨‹ï¼š**

```javascript
// 1. è¡¨å•æäº¤
const handleChatSubmit = (event) => {
  setChatError('');
  handleSubmit(event);  // Vercel AI SDK
};

// 2. useChat Hook è‡ªåŠ¨: 
// - å°†ç”¨æˆ·æ¶ˆæ¯æ·»åŠ åˆ° messages æ•°ç»„
// - è§¦å‘ POST /api/chat è¯·æ±‚
// - è®¾ç½® isLoading = true
// - å¤„ç†æµå¼å“åº”

// 3. å‘é€è¯·æ±‚ä½“
{
  messages:  [
    { role: 'assistant', content: 'å¯ä»¥ææŒ‡æ ‡é—®é¢˜æˆ–ä¸Šä¼ è¡¨æ ¼.. .' },
    { role: 'user', content: 'æˆ‘æƒ³çœ‹ä¸‹ä»Šå¤©çš„è¿è¥æ•°æ®å’Œæ—¥æŠ¥' }
  ],
  uploadId: null  // æœ¬ä¾‹ä¸­æ²¡æœ‰ä¸Šä¼ æ–‡ä»¶
}
```

**UI åé¦ˆï¼š**
- âœ… ç«‹å³æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
- âœ… æ˜¾ç¤º"å¤„ç†ä¸­..."çŠ¶æ€
- âœ… ç¦ç”¨å‘é€æŒ‰é’®

---

## **ç¬¬äº”é˜¶æ®µï¼šåç«¯ API å¤„ç†**ï¼ˆâ­ æ ¸å¿ƒæµç¨‹ï¼‰

### 5ï¸âƒ£ **Chat API ç«¯ç‚¹** (`src/ai_dashboard/app/api/chat/route.js`)

```javascript
export async function POST(request) {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ç¬¬ 1 æ­¥ï¼šéªŒè¯ä¸è§£æè¯·æ±‚
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const payload = await request.json();
  const messages = sanitizeMessages(payload?. messages, maxInputChars);
  
  if (messages.length === 0) {
    return Response.json({ error: 'è¯·è¾“å…¥é—®é¢˜å†…å®¹ã€‚' }, { status: 400 });
  }

  // æ£€æŸ¥ä¾èµ–ï¼šOpenAI API Key æˆ– MCP æœåŠ¡
  const hasOpenAI = Boolean(process.env.OPENAI_API_KEY);
  const hasMcp = Boolean(process.env.MCP_SERVER_URL);
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ç¬¬ 2 æ­¥ï¼šæ„å›¾è¯†åˆ«ä¸æ—¶é—´çª—å£è§£æ
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const windowRange = resolveWindowRange(messages, config.mcpWindowDays);
  // "æˆ‘æƒ³çœ‹ä¸‹ä»Šå¤©çš„è¿è¥æ•°æ®" 
  //   â†“ è¯†åˆ« "ä»Šå¤©"
  //   â†“ start = å½“å¤©æ—¥æœŸ, end = å½“å¤©æ—¥æœŸ, windowDays = 1
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ç¬¬ 3 æ­¥ï¼šè°ƒç”¨ MCP å·¥å…·é“¾
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const mcpReport = await shouldGenerateReport(messages)
    ? callMcpTool(
        process.env.MCP_SERVER_URL,
        'generate_dashboard_insights',  // ç”Ÿæˆæ´å¯Ÿå·¥å…·
        {
          start: windowRange.start,     // ä»Šå¤©å¼€å§‹æ—¶é—´
          end: windowRange.end,         // ä»Šå¤©ç»“æŸæ—¶é—´
          window_days: 1
        }
      )
    : null;
  
  // MCP å·¥å…·è°ƒç”¨é“¾ï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰: 
  // generate_dashboard_insights
  //   â†“ ä¾èµ– fetch_dashboard_data
  //     â†“ è·å– [start, end] èŒƒå›´çš„åŸå§‹æ•°æ®
  //       â†“ data_source. fetch_sales()  (Mock æˆ–çœŸå®æ•°æ®)
  //       â†“ data_source. fetch_traffic()
  //   â†“ ä¾èµ– compute_dashboard_metrics
  //     â†“ è®¡ç®— KPI æ‘˜è¦
  //     â†“ ä¿å­˜åˆ° SQLite (å¦‚å¯ç”¨)
  //   â†“ LLM ç”Ÿæˆè‡ªç„¶è¯­è¨€æ´å¯Ÿ
  //     â†“ "ä»Šå¤©æ€»é”€å”®é¢:  Â¥XX, è®¢å•é‡: XXX..."
  
  mcpReport = {
    report:  {
      summary: {
        source: 'Mock',
        window:  { start:  '2026-01-06', end: '2026-01-06' },
        totals: {
          revenue: 15234.50,
          units: 123,
          sessions: 4567,
          conversion_rate: 0.0269,
          refund_rate: 0.0081
        },
        top_products: [
          { asin: 'B001', title: 'äº§å“1', revenue: 5000, units: 50, ...  },
          { asin: 'B002', title: 'äº§å“2', revenue: 4000, units: 40, ... }
        ]
      },
      insights: "ä»Šå¤©çš„è¿è¥è¡¨ç°å¦‚ä¸‹ï¼š\n1. æ€»é”€å”®é¢Â¥15234.50ï¼Œè¾ƒæ˜¨æ—¥ä¸Šå‡12%\n..."
    }
  };
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ç¬¬ 4 æ­¥ï¼šæå– MCP æ•°æ®æ„å»ºå±•ç¤ºç‰©æ–™
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  mcpArtifacts = mapMcpReportToArtifacts(mcpReport);
  // è½¬æ¢ä¸º: 
  // {
  //   kpis: [
  //     { label: 'æ—¥é”€å”®é¢', value: 'Â¥15234.50', icon: 'ğŸ“ˆ' },
  //     { label: 'è®¢å•æ•°', value: '123', icon: 'ğŸ“¦' },
  //     { label: 'è½¬åŒ–ç‡', value: '2.69%', icon: 'ğŸ¯' }
  //   ],
  //   tables: [
  //     { id: 'top_products', data: [[B001, äº§å“1, 5000, ... ], ... ] }
  //   ],
  //   charts: [
  //     { id: 'daily_revenue', type: 'line', data: [... ] }
  //   ]
  // }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ç¬¬ 5 æ­¥ï¼šæ„å»ºç³»ç»Ÿæç¤ºè¯
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const systemPrompt = buildSystemPrompt({
    hasUpload: false,
    hasMcp: true,
    mcpReport: mcpReport,
    config: config
  });
  // æç¤ºè¯åŒ…å«:
  // "ä½ æ˜¯è¿è¥åˆ†æé¡¾é—®ï¼Œå·²è·å¾—ä»¥ä¸‹æ•°æ®:\n"
  // + JSON.stringify(mcpReport.summary)
  // + "\nè¯·ç”¨å‹å¥½çš„æ–¹å¼æ€»ç»“å…³é”®æŒ‡æ ‡å’Œå»ºè®®ã€‚"
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ç¬¬ 6 æ­¥ï¼šæµå¼ç”Ÿæˆ AI å›å¤
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const result = streamText({
    model: openai('gpt-5-mini'),  // ä½¿ç”¨ OpenAI æ¨¡å‹
    system: systemPrompt,
    messages: messages,
    experimental_streamData: true,
    onChunk: ({ chunk }) => {
      // è¾¹ç”Ÿæˆè¾¹æµå¼å‘é€ç»™å‰ç«¯
    }
  });
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ç¬¬ 7 æ­¥ï¼šç»„è£…æµå¼å“åº”
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const streamData = new StreamData();
  
  // æ·»åŠ æ•°æ®éƒ¨åˆ†ï¼ˆè¡¨æ ¼ã€å›¾è¡¨ç­‰ï¼‰
  streamData.append({
    type: 'data',
    data: {
      tables: mcpArtifacts. tables,
      charts: mcpArtifacts.charts,
      kpis: mcpArtifacts.kpis,
      report: null
    }
  });
  
  return result. toDataStreamResponse({ data: streamData });
  
  // è¿”å›æ ¼å¼ï¼š
  // 0:"text"
  // 0:"ä»Šå¤©çš„è¿è¥æ•°æ®å¦‚ä¸‹ï¼š\n\n"
  // 0:"ã€å…³é”®æŒ‡æ ‡ã€‘\n"
  // 0:"â€¢ é”€å”®é¢ï¼šÂ¥15234.50ï¼ˆâ†‘12% vs æ˜¨æ—¥ï¼‰\n"
  // ... æ›´å¤šæ–‡æœ¬æµ... 
  // d:[{"type":"data","data":{...}}]
  // e
}
```

**MCP å·¥å…·è°ƒç”¨è¯¦è§£ï¼š**

```python
# operations_dashboard/mcp_server. py

@mcp. tool(name="generate_dashboard_insights")
def tool_generate_dashboard_insights(
    ctx: Context,
    summary: Optional[Dict] = None,
    start:  Optional[str] = "2026-01-06",
    end: Optional[str] = "2026-01-06",
    window_days: Optional[int] = 1,
    ... 
) -> GenerateDashboardInsightsResult:
    
    # â† è°ƒç”¨ services. generate_dashboard_insights
    
    skill = _skills(ctx)["generate_dashboard_insights"]
    return skill.invoke(start=start, end=end, ...)
```

**å¯¹åº”æœåŠ¡å±‚é€»è¾‘ï¼š**

```python
# operations_dashboard/services. py

def generate_dashboard_insights(
    context: ServiceContext,
    *,
    start: str = "2026-01-06",
    end: str = "2026-01-06",
    ... 
) -> Dict[str, Any]:
    
    # 1ï¸âƒ£ å¦‚æœæœªæä¾›æ‘˜è¦ï¼Œåˆ™è‡ªåŠ¨æ‹‰å–æ•°æ®å¹¶è®¡ç®—
    if summary is None: 
        # è°ƒç”¨ fetch_dashboard_data
        data = fetch_dashboard_data(
            context,
            start=start,
            end=end,
            window_days=1
        )
        # æ•°æ®æºè¿”å›: 
        # {
        #   "start": "2026-01-06",
        #   "end": "2026-01-06",
        #   "source": "Mock",
        #   "sales": [
        #     { "day": "2026-01-06", "asin": "B001", "units_ordered": 50, ...  },
        #     { "day": "2026-01-06", "asin": "B002", "units_ordered": 40, ... }
        #   ],
        #   "traffic": [
        #     { "day":  "2026-01-06", "asin": "B001", "sessions": 2000, ... }
        #   ]
        # }
        
        # è°ƒç”¨ compute_dashboard_metrics
        metrics = compute_dashboard_metrics(
            context,
            start=data["start"],
            end=data["end"],
            source=data["source"],
            sales=data["sales"],
            traffic=data["traffic"]
        )
        # è¾“å‡º:
        # {
        #   "summary": {
        #     "source": "Mock",
        #     "window": { "start": "2026-01-06", "end": "2026-01-06" },
        #     "totals": {
        #       "revenue": 15234.50,
        #       "units":  123,
        #       "sessions": 4567,
        #       "conversion_rate": 0.0269,
        #       "refund_rate": 0.0081
        #     },
        #     "top_products": [...]
        #   }
        # }
        
        summary = metrics["summary"]
    
    # 2ï¸âƒ£ è°ƒç”¨ LLM ç”Ÿæˆè‡ªç„¶è¯­è¨€æ´å¯Ÿ
    if context.llm is None:
        raise RuntimeError("LLM missing")
    
    instructions = (
        "è¯·ä»¥èµ„æ·±è¿è¥é¡¾é—®èº«ä»½ï¼Œä¾æ®æä¾›çš„æ•°æ®ç”Ÿæˆç»“æ„åŒ–æ´å¯Ÿã€‚"
        "ä¼˜å…ˆå…³æ³¨'é”€é‡è¶‹åŠ¿ã€æµé‡å˜åŒ–ã€è½¬åŒ–ç‡ã€é€€æ¬¾'è¿™äº›ä¸»é¢˜ã€‚"
    )
    
    response = context.llm.invoke([
        SystemMessage(content=instructions),
        HumanMessage(content=f"è¯·åˆ†æä¸‹é¢çš„ JSON æ•°æ®ï¼š{summary}")
    ])
    
    # LLM è¿”å›è‡ªç„¶è¯­è¨€åˆ†æ
    insights = response.content
    # ä¾‹:  "ä»Šå¤©çš„è¿è¥è¡¨ç°å¦‚ä¸‹ï¼š\n"
    #     "1. é”€å”®æ€»é¢Â¥15234.50ï¼Œç¯æ¯”ä¸Šå‡12%"
    #     "2. è®¢å•æ•°é‡123ä¸ªï¼Œå®¢å•ä»·Â¥123.84"
    #     "3. è½¬åŒ–ç‡2.69%ï¼Œè¾ƒä¸ŠæœŸä¿æŒç¨³å®š"
    #     "4. å»ºè®®ï¼šé‡ç‚¹å…³æ³¨æµé‡æ¥æºï¼Œä¼˜åŒ–é«˜ä»·å€¼å•†å“è½¬åŒ–..."
    
    return {
        "report": {
            "summary": summary,
            "insights": insights
        }
    }
```

---

## **ç¬¬å…­é˜¶æ®µï¼šæµå¼å“åº”å¤„ç†**

### 6ï¸âƒ£ **å‰ç«¯æ¥æ”¶æµå¼æ•°æ®** (`components/Dashboard. jsx`)

```javascript
// Vercel AI SDK useChat Hook è‡ªåŠ¨å¤„ç†: 

const { messages, input, handleInputChange, handleSubmit, isLoading, data } = useChat({
  api: '/api/chat',
  initialMessages: [{ role: 'assistant', content:  'å¯ä»¥ææŒ‡æ ‡é—®é¢˜.. .' }],
  onFinish: () => {
    // æµå®Œæˆæ—¶å›è°ƒ
  }
});

// æµå¼æ¥æ”¶æµç¨‹:
// 1. æ¥æ”¶æ–‡æœ¬å— â†’ å®æ—¶è¿½åŠ åˆ°æœ€åçš„ assistant æ¶ˆæ¯
// 2. æ¥æ”¶æ•°æ®å— â†’ æ›´æ–° data æ•°ç»„ï¼ˆåŒ…å« tables/charts/kpisï¼‰
// 3. å®Œæˆæ ‡è®° â†’ è®¾ç½® isLoading = false
```

### 7ï¸âƒ£ **UI æ¸²æŸ“æ›´æ–°** (`components/ChatPanel.jsx` + `components/InsightsPanel.jsx`)

```javascript
// ChatPanel - å¯¹è¯æ˜¾ç¤º
const MessageBubble = ({ message, isTyping }) => {
  // ä½¿ç”¨ typewriter æ•ˆæœé€å­—æ˜¾ç¤º AI å›å¤
  const content = useTypewriter(message.content || '', isTyping);
  return <div className={`message ${message.role}`}>{content}</div>;
};

// InsightsPanel - KPI å’Œå›¾è¡¨æ˜¾ç¤º
<InsightsPanel
  kpis={latestData?. kpis || []}
  tables={latestData?.tables || []}
  charts={latestData?.charts || []}
/>

// æœ€ç»ˆç•Œé¢æ˜¾ç¤º:
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ å¯¹è¯é¢æ¿                â”‚ æ•°æ®é¢æ¿    â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ ç”¨æˆ·æ¶ˆæ¯:  æˆ‘æƒ³çœ‹ä¸‹...  â”‚ ğŸ“Š KPI å¡ç‰‡ â”‚
// â”‚ AI:  ä»Šå¤©è¿è¥æ•°æ®... â”‚ ğŸ“ˆ å›¾è¡¨     â”‚
// â”‚ (æ‰“å­—åŠ¨ç”»è¿›è¡Œä¸­)    â”‚ ğŸ“‹ è¡¨æ ¼     â”‚
// â”‚                      â”‚              â”‚
// â”‚ ğŸ“ è¾“å…¥æ¡†:  [_____] â”‚              â”‚
// â”‚              [å‘é€] â”‚              â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## **å®Œæ•´æµç¨‹æ—¶åºå›¾**

```
ç”¨æˆ·æ“ä½œ                å‰ç«¯ (Next.js)           åç«¯ API            MCP æœåŠ¡å™¨      æ•°æ®æº
   â”‚                       â”‚                      â”‚                      â”‚            â”‚
   â”œâ”€â”€è¾“å…¥"ä»Šå¤©æ•°æ®"â”€â”€â”€â”€â†’ ChatPanel. jsx           â”‚                      â”‚            â”‚
   â”‚                       â”‚                      â”‚                      â”‚            â”‚
   â”œâ”€â”€ç‚¹å‡»"å‘é€"â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Dashboard.jsx          â”‚                      â”‚            â”‚
   â”‚                       â”‚                      â”‚                      â”‚            â”‚
   â”‚ (æ˜¾ç¤ºè¾“å…¥æ¡†å†…å®¹)       â”‚ (useChat hook)        â”‚                      â”‚            â”‚
   â”‚                       â”‚                      â”‚                      â”‚            â”‚
   â”‚                       â”œâ”€â”€POST /api/chatâ”€â”€â†’ route. js                 â”‚            â”‚
   â”‚                       â”‚ {messages:[...]}  (éªŒè¯ & è§£æ)             â”‚            â”‚
   â”‚                       â”‚                      â”‚                      â”‚            â”‚
   â”‚                       â”‚                      â”œâ”€æ—¶é—´è¯†åˆ«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ "ä»Šå¤©"     â”‚
   â”‚                       â”‚                      â”‚ start=ä»Šæ—¥, end=ä»Šæ—¥ â”‚            â”‚
   â”‚                       â”‚                      â”‚                      â”‚            â”‚
   â”‚                       â”‚                      â”œâ”€â”€callMcpToolâ”€â”€â”€â”€â”€â”€â”€â”€â†’ initialize â”‚
   â”‚                       â”‚                      â”‚ generate_insights    â”‚ (å»ºç«‹ä¼šè¯)  â”‚
   â”‚                       â”‚                      â”‚                      â”‚            â”‚
   â”‚                       â”‚                      â”‚                      â”œâ”€fetch_dataâ†’ Mock
   â”‚                       â”‚                      â”‚                      â”‚ Sales      â”‚ æ•°æ®åº“
   â”‚                       â”‚                      â”‚                      â”‚ Traffic    â”‚
   â”‚                       â”‚                      â”‚                      â”‚            â”‚
   â”‚                       â”‚                      â”‚                      â”œâ”€computeâ”€â”€â”€â”€â†’ (KPI è®¡ç®—)
   â”‚                       â”‚                      â”‚                      â”‚ metrics    â”‚
   â”‚                       â”‚                      â”‚                      â”‚            â”‚
   â”‚                       â”‚                      â”‚                      â”œâ”€LLMâ”€â”€â”€â”€â”€â”€â”€â”€â†’ OpenAI
   â”‚                       â”‚                      â”‚                      â”‚ generate   â”‚ (æ´å¯Ÿ)
   â”‚                       â”‚                      â”‚                      â”‚ insights   â”‚
   â”‚                       â”‚                      â”‚                      â”‚            â”‚
   â”‚                       â”‚                      â”‚â—„â”€â”€â”€â”€â”€report dataâ”€â”€â”€â”€â”€ report      â”‚
   â”‚                       â”‚                      â”‚ {summary, insights}  â”‚            â”‚
   â”‚                       â”‚                      â”‚                      â”‚            â”‚
   â”‚                       â”‚ â—„â”€â”€streamText()â”€â”€â”€â”€â”€â”€ (æµå¼ AI ç”Ÿæˆå›å¤)     â”‚            â”‚
   â”‚                       â”‚                      â”‚ chunk1: "ä»Šå¤©è¿è¥..."â”‚            â”‚
   â”‚                       â”‚                      â”‚ chunk2: "é”€å”®é¢Â¥..."â”‚            â”‚
   â”‚                       â”‚                      â”‚ data: {kpis,charts} â”‚            â”‚
   â”‚                       â”‚                      â”‚ ...                   â”‚            â”‚
   â”‚ (æ›´æ–°æ¶ˆæ¯)            â”‚ (æ¥æ”¶æµ)              â”‚                      â”‚            â”‚
   â”‚                       â”‚ onChunk(chunk)       â”‚                      â”‚            â”‚
   â”‚                       â”‚ append to messages   â”‚                      â”‚            â”‚
   â”‚                       â”‚                      â”‚                      â”‚            â”‚
   â”‚ (æ˜¾ç¤º KPI)            â”‚ useTypewriter()      â”‚                      â”‚            â”‚
   â”‚ (æ¸²æŸ“å›¾è¡¨)            â”‚ animate text         â”‚                      â”‚            â”‚
   â”‚                       â”‚ update kpis/charts   â”‚                      â”‚            â”‚
   â”‚                       â”‚ from data array      â”‚                      â”‚            â”‚
   â”‚                       â”‚                      â”‚                      â”‚            â”‚
   â”‚ (å®Œæˆ)                â”‚ isLoading = false    â”‚                      â”‚            â”‚
   â”‚                       â”‚ ready for new input  â”‚                      â”‚            â”‚
```

---

## **å…³é”®æ•°æ®æµ**

### **è¯·æ±‚æ•°æ®ï¼š**
```json
{
  "messages": [
    {
      "role": "assistant",
      "content": "å¯ä»¥ææŒ‡æ ‡é—®é¢˜æˆ–ä¸Šä¼ è¡¨æ ¼..."
    },
    {
      "role": "user",
      "content": "æˆ‘æƒ³çœ‹ä¸‹ä»Šå¤©çš„è¿è¥æ•°æ®å’Œæ—¥æŠ¥"
    }
  ],
  "uploadId": null
}
```

### **MCP å·¥å…·è°ƒç”¨å‚æ•°ï¼š**
```json
{
  "start": "2026-01-06",
  "end": "2026-01-06",
  "window_days": 1
}
```

### **MCP è¿”å›æ•°æ®ï¼š**
```json
{
  "report": {
    "summary": {
      "source": "Mock",
      "window": {
        "start": "2026-01-06",
        "end": "2026-01-06"
      },
      "totals": {
        "revenue": 15234.50,
        "units": 123,
        "sessions": 4567,
        "conversion_rate": 0.0269,
        "refund_rate": 0.0081
      },
      "top_products": [
        {
          "asin": "B001",
          "title": "Product A",
          "revenue": 5000.00,
          "units":  50,
          "sessions":  2000,
          "conversion_rate": 0.025
        }
      ]
    },
    "insights": "ä»Šå¤©çš„è¿è¥è¡¨ç°å¦‚ä¸‹ï¼š\n1. æ€»é”€å”®é¢Â¥15234.50.. .\n2. æ ¸å¿ƒå•†å“è´¡çŒ®åº¦é«˜...\n3. å»ºè®®å…³æ³¨æµé‡è´¨é‡..."
  }
}
```

### **æœ€ç»ˆå‰ç«¯æ˜¾ç¤ºæµç¨‹ï¼š**
```
ã€å¯¹è¯é¢æ¿ã€‘                    ã€æ•°æ®é¢æ¿ã€‘
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç”¨æˆ·:  æˆ‘æƒ³çœ‹ä¸‹ä»Šå¤©çš„            ğŸ“Š KPI å¡ç‰‡
è¿è¥æ•°æ®å’Œæ—¥æŠ¥               â”œâ”€ é”€å”®é¢:  Â¥15,234.50
                              â”œâ”€ è®¢å•æ•°: 123
AI: ä»Šå¤©çš„è¿è¥è¡¨ç°å¦‚ä¸‹ï¼š       â”œâ”€ è½¬åŒ–ç‡: 2.69%
(é€å­—æ‰“å­—åŠ¨ç”»ä¸­)              â”œâ”€ é€€æ¬¾ç‡: 0.81%
                              
1. æ€»é”€å”®é¢Â¥15234.50          ğŸ“ˆ å›¾è¡¨
   ç¯æ¯”æå‡12%               â”œâ”€ æ—¥é”€å”®è¶‹åŠ¿
2. Top å•†å“:  Product A       â”œâ”€ Top 5 äº§å“é”€å”®é¢
3. å»ºè®®å…³æ³¨æµé‡è´¨é‡           
                              ğŸ“‹ Top å•†å“è¡¨æ ¼
[è¾“å…¥æ¡†] [å‘é€æŒ‰é’®]           â”œâ”€ Product A:  Â¥5000
                              â”œâ”€ Product B: Â¥4000
```

---

## **å…³é”®ç»„ä»¶å’Œæ–‡ä»¶æ€»ç»“**

| å±‚çº§ | ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|------|
| **å‰ç«¯** | ChatPanel | `src/ai_dashboard/components/ChatPanel.jsx` | å¯¹è¯ç•Œé¢ã€æ¶ˆæ¯è¾“å…¥ |
| | Dashboard | `src/ai_dashboard/components/Dashboard.jsx` | æ•´ä½“ç¼–æ’ã€æ•°æ®ç®¡ç† |
| | InsightsPanel | `src/ai_dashboard/components/InsightsPanel.jsx` | KPIã€å›¾è¡¨ã€è¡¨æ ¼å±•ç¤º |
| **API å±‚** | Chat API | `src/ai_dashboard/app/api/chat/route.js` | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ |
| | MCP Client | `src/ai_dashboard/lib/mcpClient.js` | MCP é€šä¿¡ |
| **åç«¯** | MCP Server | `operations_dashboard/mcp_server.py` | FastMCP æ¡†æ¶ã€å·¥å…·æš´éœ² |
| | Services | `operations_dashboard/services.py` | ä¸šåŠ¡é€»è¾‘ï¼ˆå–æ•°ã€ç®—æŒ‡æ ‡ã€ç”Ÿæˆæ´å¯Ÿï¼‰ |
| | Skills | `operations_dashboard/skills/` | æŠ€èƒ½å°è£… |
| **æ•°æ®** | Data Source | `operations_dashboard/data_sources/` | Mock/çœŸå®æ•°æ®æº |
| | Storage | `operations_dashboard/storage/` | SQLite æŒä¹…åŒ– |

---

## **æ ¸å¿ƒè°ƒç”¨é“¾**

```
å‰ç«¯ç”¨æˆ·è¾“å…¥
  â†“
POST /api/chat
  â†“
resolveWindowRange() - è¯†åˆ«æ—¶é—´
  â†“
callMcpTool('generate_dashboard_insights')
  â”œâ”€ MCP initialize (å»ºç«‹ä¼šè¯)
  â”œâ”€ fetch_dashboard_data (æ‹‰å–åŸå§‹æ•°æ®)
  â”œâ”€ compute_dashboard_metrics (è®¡ç®— KPI)
  â”œâ”€ LLM (ç”Ÿæˆæ´å¯Ÿ)
  â””â”€ terminate (å…³é—­ä¼šè¯)
  â†“
mapMcpReportToArtifacts() - æ•°æ®è½¬æ¢
  â†“
streamText() - OpenAI æµå¼ç”Ÿæˆå›å¤
  â†“
formatStreamPart() - æ ¼å¼åŒ–æµæ•°æ®
  â†“
å‰ç«¯æ¥æ”¶æµ (useChat + MessageBubble)
  â†“
UI æ¸²æŸ“ (KPIå¡ç‰‡ã€å›¾è¡¨ã€å¯¹è¯)
```

è¿™å°±æ˜¯æ‚¨ä»è¾“å…¥"æˆ‘æƒ³çœ‹ä¸‹ä»Šå¤©çš„è¿è¥æ•°æ®å’Œæ—¥æŠ¥"åˆ°çœ‹åˆ°å®Œæ•´ç»“æœçš„å®Œæ•´å·¥ä½œæµç¨‹ï¼ğŸ‰
